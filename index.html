<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IndexedDB Inspector — Hacker Theme</title>
<style>
/* --------------------
   Base terminal look
   -------------------- */
:root{
  --bg:#0a0a0a;
  --muted:#c0c0c0;
  --soft-green:#6088ff;
  --meta:#7299ff;
  --panel:#111;
  --border-green:#3055aa;
  --accent:#374888;
  --json:#c0e4ff;
  --error-bg:#330000;
}

html,body{height:100%}
body {
    background: var(--bg);
    color: var(--muted);
    font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", ui-monospace, SFMono-Regular, Menlo, monospace;
    padding: 20px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.4;
}

/* headings */
h1{margin:0 0 10px;color:var(--soft-green);font-size:20px}
.note{color:#9fb0d8;margin:6px 0 18px;font-size:13px}

/* controls */
.controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
button{
    background: var(--panel);
    color: var(--soft-green);
    border: 1px solid rgba(0,255,119,0.16);
    padding:6px 10px;
    border-radius:6px;
    font-family:inherit;
    cursor:pointer;
    transition: all .18s ease;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);
}
button:disabled{opacity:.5;cursor:default}
button:hover{ background:#081208; box-shadow:0 0 8px rgba(0,255,119,0.06); transform:translateY(-1px); }

label.small{color:#9fb0d8;font-size:13px}
input[type=number]{
    width:86px;padding:6px;border-radius:6px;border:1px solid rgba(0,255,119,0.06);
    background:var(--panel);color:var(--muted);font-family:inherit;
}

/* output area */
#out{margin-top:18px}

/* DB box */
.db{
    border:1px solid rgba(0,170,68,0.14);
    padding:12px;margin-bottom:14px;background:var(--panel);border-radius:8px;
    opacity:0; transform:translateY(8px); animation:fadeInUp .38s forwards;
}
.db h2{margin:0 0 8px;font-size:16px;color:var(--soft-green)}

/* store box */
.store{
    border:1px dashed rgba(0,136,51,0.12);
    padding:10px;margin-top:10px;background:var(--panel);border-radius:6px;
    opacity:0; transform:translateY(6px); animation:fadeInUp .32s forwards;
}
.meta{font-size:13px;color:var(--meta);margin-bottom:6px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* small pill */
.pill{background:rgba(7,32,36,0.6);padding:6px 8px;border-radius:999px;border:1px solid rgba(0,130,90,0.06);color:#bfe0ff;font-size:13px}

/* JSON panel */
pre{
    white-space:pre-wrap;background:var(--panel);border:1px solid rgba(0,170,68,0.06);
    padding:10px;margin-top:10px;color:var(--json);border-radius:6px;max-height:360px;overflow:auto;
    transition:all .26s ease;
}

/* actions */
.actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

/* error */
.error{color:#ffb4b4;background:var(--error-bg);padding:8px;border-radius:6px;border:1px solid #ff4444;opacity:0;animation:fadeInUp .38s forwards}

/* typewriter reading */
.typewriter{display:inline-block;overflow:hidden;border-right:2px solid rgba(0,255,119,0.9);white-space:nowrap;animation:typing .8s steps(20,end), blink .8s step-end infinite;}
@keyframes typing{from{width:0}to{width:100%}}
@keyframes blink{50%{border-color:transparent}}

/* fade in */
@keyframes fadeInUp{to{opacity:1;transform:translateY(0)}}

/* JSON expand animation class */
pre.show{animation:fadeInPre .22s forwards}
@keyframes fadeInPre{from{opacity:0;max-height:0}to{opacity:1;max-height:360px}}

/* subtle focus outlines for accessibility */
button:focus, input:focus { outline:2px solid rgba(0,255,119,0.07); outline-offset:2px; }

/* responsive tweaks */
@media (max-width:640px){
  .controls{flex-direction:column;align-items:flex-start}
  input[type=number]{width:100%}
}
</style>
</head>
<body>
  <h1>IndexedDB Inspector</h1>
  <div class="note">
    Runs on the current origin. Click <strong>Scan databases</strong> to list DBs and their contents. If nothing appears, open DevTools Console for messages.
  </div>

  <div class="controls">
    <button id="scanBtn">Scan databases</button>
    <label class="small">Max records per store:
      <input id="limitInput" type="number" min="1" value="500" />
    </label>
    <button id="clearBtn">Clear results</button>
    <div style="margin-left:auto" class="small">Last scan: <span id="lastScan">never</span></div>
  </div>

  <div id="out"></div>

<script>
(() => {
  const out = document.getElementById('out');
  const scanBtn = document.getElementById('scanBtn');
  const clearBtn = document.getElementById('clearBtn');
  const lastScan = document.getElementById('lastScan');
  const limitInput = document.getElementById('limitInput');

  function makeEl(tag, props={}, children=[]){
    const e = document.createElement(tag);
    Object.assign(e, props);
    (children||[]).forEach(c => e.appendChild(c));
    return e;
  }

  function isoNow(){ return new Date().toLocaleString(); }

  // download JSON
  function downloadJSON(filename, obj){
    try{
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }catch(e){
      console.error('Download failed', e);
    }
  }

  // copy text
  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){ return false; }
  }

  // Read all records from an object store (up to limit)
  function readAllFromStore(db, storeName, limit=500){
    return new Promise((resolve) => {
      let results = [];
      let truncated = false;
      try{
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.openCursor();
        request.onsuccess = (ev) => {
          const cursor = ev.target.result;
          if(!cursor || results.length >= limit){
            truncated = !!cursor;
            resolve({items:results, truncated});
            return;
          }
          results.push(cursor.value);
          cursor.continue();
        };
        request.onerror = () => {
          resolve({error: request.error ? request.error.message : 'cursor error'});
        };
      }catch(err){
        resolve({error: err && err.message ? err.message : String(err)});
      }
    });
  }

  // sanitize filename
  function sanitize(s){
    return String(s).replace(/[<>:"/\\|?*\x00-\x1F]/g,'_').slice(0,120);
  }

  // Inspect one database: list stores and their content
  async function inspectDatabase(dbInfo, limit){
    const name = dbInfo.name;
    const version = dbInfo.version || 'unknown';
    const container = makeEl('div', {className:'db'});
    const title = makeEl('h2', {innerText: `DB: ${name} (v${version})`});
    container.appendChild(title);
    const meta = makeEl('div', {className:'meta', innerText: `Opened at ${isoNow()}`});
    container.appendChild(meta);

    try {
      const openReq = indexedDB.open(name);
      const db = await new Promise((resolve, reject) => {
        openReq.onsuccess = e => resolve(e.target.result);
        openReq.onerror = e => reject(e.target.error || new Error('open error'));
        openReq.onupgradeneeded = () => {
          // don't change schema; wait for success
        };
      });

      const stores = Array.from(db.objectStoreNames || []);
      if(stores.length === 0){
        container.appendChild(makeEl('div', {className:'small', innerText:'No object stores.'}));
      } else {
        for(const storeName of stores){
          const storeBox = makeEl('div', {className:'store'});
          const h = makeEl('div', {innerHTML: `<strong style="color:var(--soft-green)">Store:</strong> ${storeName}`});
          storeBox.appendChild(h);

          // metadata
          try{
            const tx = db.transaction(storeName, 'readonly');
            const sRef = tx.objectStore(storeName);
            const info = `keyPath: ${JSON.stringify(sRef.keyPath)}  •  autoIncrement: ${sRef.autoIncrement}`;
            storeBox.appendChild(makeEl('div', {className:'meta', innerText: info}));
          }catch(errMeta){
            storeBox.appendChild(makeEl('div', {className:'meta', innerText: 'store metadata unavailable'}));
          }

          // reading indicator (typewriter)
          const reading = makeEl('div', {innerHTML: '<span class="typewriter">Reading store...</span>'});
          storeBox.appendChild(reading);
          container.appendChild(storeBox);

          try {
            const {items, truncated, error} = await readAllFromStore(db, storeName, limit);
            // remove reading indicator
            reading.remove();

            if(error){
              storeBox.appendChild(makeEl('div', {className:'error', innerText: `Error reading store: ${error}`}));
              continue;
            }

            const actions = makeEl('div', {className:'actions'});
            const countPill = makeEl('span', {className:'pill', innerText: `Records: ${items.length}${truncated ? ' (more...)' : ''}`});
            actions.appendChild(countPill);

            const jsonObj = {db: name, version, store: storeName, records: items};
            const pretty = JSON.stringify(jsonObj, null, 2);

            const downloadBtn = makeEl('button', {innerText: 'Download JSON'});
            downloadBtn.onclick = () => downloadJSON(`${sanitize(name)}--${sanitize(storeName)}.json`, jsonObj);
            actions.appendChild(downloadBtn);

            const copyBtn = makeEl('button', {innerText: 'Copy JSON'});
            copyBtn.onclick = async () => {
              const ok = await copyText(pretty);
              copyBtn.innerText = ok ? 'Copied!' : 'Copy failed';
              setTimeout(()=> copyBtn.innerText = 'Copy JSON', 1200);
            };
            actions.appendChild(copyBtn);

            const viewBtn = makeEl('button', {innerText: 'Show JSON'});
            const pre = makeEl('pre', {innerText: pretty});
            pre.style.display = 'none';
            viewBtn.onclick = () => {
              if(pre.style.display === 'none'){
                pre.style.display = 'block';
                pre.classList.add('show');
                viewBtn.innerText = 'Hide JSON';
              } else {
                pre.style.display = 'none';
                pre.classList.remove('show');
                viewBtn.innerText = 'Show JSON';
              }
            };
            actions.appendChild(viewBtn);

            storeBox.appendChild(actions);
            storeBox.appendChild(pre);

          } catch (err) {
            reading.remove();
            storeBox.appendChild(makeEl('div', {className:'error', innerText: `Read error: ${err && err.message ? err.message : err}`}));
          }
        }
      }

      try{ db.close(); }catch(e){}

    } catch (errOpen) {
      container.appendChild(makeEl('div', {className:'error', innerText: `Failed to open DB "${name}": ${errOpen && errOpen.message ? errOpen.message : errOpen}`}));
    }

    return container;
  }

  // Main scan
  async function scanAll(){
    scanBtn.disabled = true; clearBtn.disabled = true;
    lastScan.innerText = 'scanning...';
    const limit = Math.max(1, Number(limitInput.value) || 500);

    try {
      if(indexedDB.databases){
        let dbList = [];
        try{
          dbList = await indexedDB.databases();
        }catch(e){
          // some browsers block it; show message but continue to allow manualInspect
          out.appendChild(makeEl('div', {className:'error', innerText: 'indexedDB.databases() threw or is blocked: ' + (e && e.message ? e.message : e)}));
        }

        if(!dbList || dbList.length === 0){
          out.appendChild(makeEl('div', {className:'small', innerText: 'No databases returned by indexedDB.databases(). You can run window.manualInspect(["DBName"]) in the console.'}));
        } else {
          for(const dbInfo of dbList){
            const node = await inspectDatabase(dbInfo, limit);
            out.appendChild(node);
          }
        }
      } else {
        out.appendChild(makeEl('div', {className:'small', innerText: 'indexedDB.databases() not supported. Use window.manualInspect(["DBName"]) in console.'}));
      }
    } catch(err){
      out.appendChild(makeEl('div', {className:'error', innerText: 'Scan error: ' + (err && err.message ? err.message : String(err))}));
    } finally {
      scanBtn.disabled = false; clearBtn.disabled = false;
      lastScan.innerText = isoNow();
    }
  }

  // Manual inspect function for browsers that block listing
  window.manualInspect = async function(names, limitOverride){
    if(!Array.isArray(names)) return console.error('manualInspect expects an array of names');
    const limit = Math.max(1, Number(limitOverride || limitInput.value) || 500);
    for(const name of names){
      const dbInfo = {name, version: undefined};
      const node = await inspectDatabase(dbInfo, limit);
      out.appendChild(node);
    }
    lastScan.innerText = isoNow();
  };

  // wire UI
  scanBtn.onclick = () => { out.innerHTML = ''; scanAll(); };
  clearBtn.onclick = () => { out.innerHTML = ''; lastScan.innerText = 'never'; };

  // initial hint
  out.innerHTML = `<div class="small">Press <strong>Scan databases</strong> to enumerate IndexedDB databases and view contents. If this page isn't on the same origin as the DB, open the script in the target site's console instead.</div>`;

})();
</script>
</body>
</html>
